<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | The Lalit International</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="init.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="wrapper">
    <script src="menu.js"></script>

    <div class="main-content">
        <div class="royal-card" style="padding: 20px 40px; border-bottom: 4px solid var(--accent); display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1 style="margin:0; font-family:'Cinzel'; color:var(--primary);">Control Dashboard</h1>
                <p style="margin:5px 0; color:#666;">Welcome to Imperial School Management System</p>
            </div>
            <div id="liveTime" style="text-align: right; font-weight: bold; color: var(--primary);"></div>
        </div>

        <div class="form-grid" style="margin-bottom: 30px;">
            <div class="royal-card" style="text-align: center; border-top-color: #3498db;">
                <i class="fas fa-user-graduate fa-2x" style="color:#3498db; margin-bottom: 10px;"></i>
                <h4 style="margin:0; color:#666;">Students</h4>
                <h2 id="totalStudents" style="margin:10px 0 0 0;">0</h2>
            </div>
            <div class="royal-card" style="text-align: center; border-top-color: var(--success);">
                <i class="fas fa-wallet fa-2x" style="color:var(--success); margin-bottom: 10px;"></i>
                <h4 style="margin:0; color:#666;">Today's Fee</h4>
                <h2 id="todayCollection" style="margin:10px 0 0 0;">₹0</h2>
            </div>
            <div class="royal-card" style="text-align: center; border-top-color: #e67e22;">
                <i class="fas fa-clock fa-2x" style="color:#e67e22; margin-bottom: 10px;"></i>
                <h4 style="margin:0; color:#666;">Attendance</h4>
                <h2 id="todayAttendance" style="margin:10px 0 0 0;">0%</h2>
            </div>
            <div class="royal-card" style="text-align: center; border-top-color: var(--danger);">
                <i class="fas fa-exclamation-circle fa-2x" style="color:var(--danger); margin-bottom: 10px;"></i>
                <h4 style="margin:0; color:#666;">Fee Pending</h4>
                <h2 id="pendingFees" style="margin:10px 0 0 0;">0</h2>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 1.2fr; gap: 30px;">
            <div class="royal-card">
                <h3 class="card-title"><i class="fas fa-chart-area"></i> Revenue Insights</h3>
                <canvas id="mainChart" style="max-height: 300px;"></canvas>
            </div>

            <div class="royal-card">
                <h3 class="card-title"><i class="fas fa-bolt"></i> Quick Links</h3>
                <div style="display: grid; gap: 15px;">
                    <button class="btn-royal" onclick="location.href='add-student.html'"><i class="fas fa-plus"></i> New Admission</button>
                    <button class="btn-royal" onclick="location.href='collect-fees.html'"><i class="fas fa-rupee-sign"></i> Collect Fee</button>
                    <button class="btn-royal" onclick="location.href='attendance.html'"><i class="fas fa-check"></i> Take Attendance</button>
                    <button class="btn-royal" onclick="location.href='report-card.html'"><i class="fas fa-print"></i> Print Results</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Live Time Feature
function updateTime() {
    const now = new Date();
    document.getElementById('liveTime').innerHTML = now.toDateString() + "<br>" + now.toLocaleTimeString();
}
setInterval(updateTime, 1000);
updateTime();

// Real-time Dashboard Updates
async function updateStats() {
    // 1. Student Count
    db.collection('students').onSnapshot(snap => {
        document.getElementById('totalStudents').innerText = snap.size;
    });

    // 2. Today's Collection
    const today = new Date().toLocaleDateString('en-GB');
    db.collection('fee_transactions').where('date', '==', today).onSnapshot(snap => {
        let total = 0;
        snap.forEach(doc => total += Number(doc.data().amount || 0));
        document.getElementById('todayCollection').innerText = "₹" + total.toLocaleString('en-IN');
    });
}

// Chart Visualization
function renderChart() {
    const ctx = document.getElementById('mainChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
            datasets: [{
                label: 'Collection',
                data: [1200, 1900, 3000, 5000, 2000, 3000],
                borderColor: '#002366',
                backgroundColor: 'rgba(0,35,102,0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } }
        }
    });
}

window.onload = () => {
    updateStats();
    renderChart();
};
</script>

</body>
</html>
