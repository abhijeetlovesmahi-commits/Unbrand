<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Student | Admission Portal</title>
    <link rel="stylesheet" href="assets/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="assets/config.js"></script>
</head>
<body>

<div class="container">
    <div class="header">
        <center>
            <img src="" id="schoolLogo" style="width:90px; margin-bottom: 5px;">
            <h2 id="formTitle">Loading...</h2>
            <p id="brandLabel" style="letter-spacing: 2px; font-size: 0.75rem; color: var(--accent-gold); font-weight: bold;"></p>
        </center>
    </div>

    <form id="studentAdmissionForm">
        <section class="form-section">
            <span class="section-title">ğŸ“¸ Student Photograph</span>
            <div style="text-align: center;">
                <input type="file" id="studentPhoto" accept="image/*" onchange="previewImage(this)">
                <center>
                    <div style="width:110px; height:130px; border-radius:15px; background:var(--bg-light); box-shadow: var(--inner-shadow); margin-top:10px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        <img id="imgPreview" style="width:100%; height:100%; object-fit:cover; display:none;">
                        <span id="placeholderText" style="font-size: 0.7rem; color: #888;">No Photo</span>
                    </div>
                </center>
            </div>
        </section>

        <section class="form-section">
            <span class="section-title">ğŸ‘¤ Personal Details</span>
            <div class="input-grid">
                <input type="text" id="sName" placeholder="Student Full Name" required>
                <input type="text" id="sDob" placeholder="Date of Birth" onfocus="(this.type='date')" required>
                <select id="sGender">
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
                <input type="text" id="sBlood" placeholder="Blood Group">
                <input type="number" id="sAadhar" placeholder="12 Digit Aadhar Number" oninput="if(this.value.length>12) this.value=this.value.slice(0,12)" required>
            </div>
        </section>

        <section class="form-section">
            <span class="section-title">ğŸ“ Academic & Facilities</span>
            <div class="input-grid">
                <select id="sClass" required>
                    <option value="Pre-Nursery">Pre-Nursery</option>
                    <option value="Nursery">Nursery</option>
                    <option value="LKG">LKG</option>
                    <option value="UKG">UKG</option>
                    <option value="1">Class 1</option><option value="2">Class 2</option><option value="3">Class 3</option>
                    <option value="4">Class 4</option><option value="5">Class 5</option><option value="6">Class 6</option>
                    <option value="7">Class 7</option><option value="8">Class 8</option><option value="9">Class 9</option>
                    <option value="10">Class 10</option><option value="11">Class 11</option><option value="12">Class 12</option>
                </select>
                <select id="sSection" required>
                    <option value="A">Section A</option><option value="B">Section B</option><option value="C">Section C</option>
                </select>
                <select id="sTransport" onchange="toggleTransport()">
                    <option value="No">Transport Needed? (No)</option>
                    <option value="Yes">Yes</option>
                </select>
                <input type="text" id="sTransportDist" placeholder="Distance in KM" style="display:none;">
            </div>
        </section>

        <section class="form-section">
            <span class="section-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ Family Details</span>
            <div class="input-grid">
                <input type="text" id="pFather" placeholder="Father's Name" required>
                <input type="text" id="pMother" placeholder="Mother's Name" required>
                <input type="tel" id="pContact" placeholder="Contact Number" required>
            </div>
        </section>

        <section class="form-section">
            <span class="section-title">ğŸ  Address Details</span>
            <input type="text" id="currAddr" placeholder="Current Address" required oninput="syncAddress()">
            <div style="margin: 10px 0;">
                <input type="checkbox" id="sameAddress" onclick="syncAddress()"> <label>Permanent same as current</label>
            </div>
            <input type="text" id="permAddr" placeholder="Permanent Address" required>
        </section>

        <button type="submit" id="submitBtn" class="main-btn">ğŸš€ SAVE STUDENT DATA</button>
    </form>

    <div style="margin-top: 40px;">
        <span class="section-title">ğŸ†• Recent Admissions (Latest 10)</span>
        <div id="recentCardsContainer" class="recent-grid"></div>
    </div>
</div>

<script>
// --- UI LOGIC ---
function toggleTransport() {
    document.getElementById('sTransportDist').style.display = (document.getElementById('sTransport').value === 'Yes') ? 'block' : 'none';
}

function syncAddress() {
    const isSame = document.getElementById('sameAddress').checked;
    if(isSame) document.getElementById('permAddr').value = document.getElementById('currAddr').value;
}

function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('imgPreview').src = e.target.result;
            document.getElementById('imgPreview').style.display = 'block';
            document.getElementById('placeholderText').style.display = 'none';
        }
        reader.readAsDataURL(input.files[0]);
    }
}

// --- PHOTO COMPRESS ---
async function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 200; canvas.height = 240;
                ctx.drawImage(img, 0, 0, 200, 240);
                resolve(canvas.toDataURL('image/jpeg', 0.6));
            };
        };
    });
}

// --- DATABASE SAVE ---
document.getElementById('studentAdmissionForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.innerText = "â³ SAVING..."; btn.disabled = true;

    let photoBase64 = "";
    const file = document.getElementById('studentPhoto').files[0];
    if(file) photoBase64 = await compressImage(file);

    const data = {
        name: document.getElementById('sName').value,
        dob: document.getElementById('sDob').value,
        gender: document.getElementById('sGender').value,
        aadhar: document.getElementById('sAadhar').value,
        class: document.getElementById('sClass').value,
        section: document.getElementById('sSection').value,
        father: document.getElementById('pFather').value,
        mother: document.getElementById('pMother').value,
        contact: document.getElementById('pContact').value,
        currentAddress: document.getElementById('currAddr').value,
        permanentAddress: document.getElementById('permAddr').value,
        photo: photoBase64,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        await db.collection("students").add(data);
        alert("ğŸ‰ Admission Done!");
        e.target.reset();
        document.getElementById('imgPreview').style.display = 'none';
        loadRecent();
    } catch(err) { alert("Error: " + err); }
    btn.innerText = "ğŸš€ SAVE STUDENT DATA"; btn.disabled = false;
};

// --- LOAD RECENT ---
async function loadRecent() {
    const container = document.getElementById('recentCardsContainer');
    const snap = await db.collection("students").orderBy("timestamp", "desc").limit(10).get();
    container.innerHTML = "";
    snap.forEach(doc => {
        const s = doc.data();
        container.innerHTML += `
            <div class="profile-card">
                <img src="${s.photo || 'https://via.placeholder.com/80'}">
                <h4>${s.name}</h4>
                <p>${s.class} - ${s.section}</p>
                <p style="font-size:10px;">${doc.id.substring(0,8)}</p>
            </div>`;
    });
}
window.addEventListener('DOMContentLoaded', loadRecent);
</script>
</body>
</html>
