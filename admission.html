<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Admission Form - School Pro</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f4f8; padding: 20px; margin: 0; }
        .form-card { background: white; padding: 30px; border-radius: 15px; max-width: 900px; margin: auto; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        label { font-weight: bold; display: block; margin-top: 10px; color: #34495e; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        .photo-section { text-align: center; border: 2px dashed #3498db; padding: 20px; border-radius: 10px; grid-column: span 2; background: #f9f9f9; }
        #preview-img { width: 120px; height: 150px; object-fit: cover; border-radius: 5px; display: none; margin: 10px auto; border: 2px solid #ddd; }
        .btn-submit { grid-column: span 2; background: #27ae60; color: white; padding: 18px; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: 0.3s; }
        .btn-submit:hover { background: #219150; }
        .section-title { grid-column: span 2; background: #34495e; color: white; padding: 10px; margin-top: 20px; border-radius: 5px; font-weight: bold; }
        .back-link { display: block; text-align: center; margin-top: 15px; color: #3498db; text-decoration: none; font-weight: bold; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="form-card">
    <h2>ðŸŽ“ Master Admission Form</h2>
    <div class="grid">
        <div class="photo-section">
            <label>Student Passport Photo</label>
            <input type="file" id="stuPhoto" accept="image/*">
            <img id="preview-img" src="">
        </div>

        <div class="section-title">1. Student Identity</div>
        <div>
            <label>Full Name:</label>
            <input type="text" id="fullName" placeholder="Enter student name" required>
        </div>
        <div>
            <label>Date of Birth:</label>
            <input type="date" id="dob">
        </div>
        
        <div>
            <label>Admission Class:</label>
            <select id="class" required>
                <option value="">-- Select Class --</option>
                <option>Pre-Nursery</option><option>Nursery</option><option>LKG</option><option>UKG</option>
                <option>1st</option><option>2nd</option><option>3rd</option><option>4th</option><option>5th</option>
                <option>6th</option><option>7th</option><option>8th</option><option>9th</option><option>10th</option>
                <option>11th</option><option>12th</option>
            </select>
        </div>
        
        <div>
            <label>Section:</label>
            <select id="section">
                <option>A</option><option>B</option><option>C</option><option>D</option>
            </select>
        </div>

        <div>
            <label>House Color:</label>
            <select id="house">
                <option value="Red">Red House</option>
                <option value="Blue">Blue House</option>
                <option value="Green">Green House</option>
                <option value="Yellow">Yellow House</option>
            </select>
        </div>

        <div>
            <label>Aadhar Number:</label>
            <input type="text" id="aadhar" placeholder="12-digit Aadhar">
        </div>

        <div class="section-title">2. Parent & Contact Details</div>
        <input type="text" id="fatherName" placeholder="Father's Name">
        <input type="text" id="motherName" placeholder="Mother's Name">
        <input type="tel" id="contact" placeholder="Mobile Number (Login Password)">
        <input type="text" id="address" placeholder="Residential Address" style="grid-column: span 2;">

        <div class="section-title">3. Transport & Facilities</div>
        <div>
            <label>Hostel Facility:</label>
            <select id="hostel">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
            </select>
        </div>

        <div>
            <label>School Transport:</label>
            <select id="transport" onchange="toggleKm()">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
            </select>
        </div>

        <div>
            <label>Distance (If Transport Yes):</label>
            <select id="km" disabled>
                <option value="0-3 KM">0-3 KM</option>
                <option value="3-6 KM">3-6 KM</option>
                <option value="6-10 KM">6-10 KM</option>
                <option value="10-30 KM">10-30 KM</option>
            </select>
        </div>

        <div>
            <label>School Books Needed:</label>
            <select id="books">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
            </select>
        </div>

        <button id="submitBtn" class="btn-submit">Finalize Admission & Generate ID</button>
    </div>
    <a href="admin.html" class="back-link">Cancel & Return to Dashboard</a>
    <p id="msg" style="text-align:center; font-weight:bold; margin-top: 15px;"></p>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, setDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD66kWwzsUS4iOZ-4ssE9w9kG1N4fBOOzk",
        authDomain: "abhijeet-69d56.firebaseapp.com",
        projectId: "abhijeet-69d56",
        appId: "1:490125802939:web:3fda6b6b9b4c1af984d89e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let stuPhotoBase64 = "";

    window.toggleKm = () => {
        document.getElementById('km').disabled = document.getElementById('transport').value === "No";
    };

    document.getElementById('stuPhoto').onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.getElementById('canvas');
                cvs.width = 200; cvs.height = 200;
                cvs.getContext('2d').drawImage(img, 0, 0, 200, 200);
                stuPhotoBase64 = cvs.toDataURL('image/jpeg', 0.7);
                document.getElementById('preview-img').src = stuPhotoBase64;
                document.getElementById('preview-img').style.display = 'block';
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };

    document.getElementById('submitBtn').onclick = async () => {
        const name = document.getElementById('fullName').value;
        const className = document.getElementById('class').value;
        const contact = document.getElementById('contact').value;
        const msg = document.getElementById('msg');
        const btn = document.getElementById('submitBtn');

        if(!name || !className || !contact) return alert("Please fill Name, Class and Contact!");

        btn.innerText = "â³ System Processing...";
        btn.disabled = true;

        try {
            // 1. UNIQUE PERMANENT ID (Total students count + 1)
            const allSnap = await getDocs(collection(db, "users"));
            let studentCount = 0;
            allSnap.forEach(d => { if(d.data().role === "student") studentCount++; });
            const uniqueID = "SCH-" + (10001 + studentCount);

            // 2. CLASS ROLL NO (Current class students count + 1)
            const q = query(collection(db, "users"), where("class", "==", className));
            const classSnap = await getDocs(q);
            const rollNo = classSnap.size + 1;

            const studentData = {
                uid: uniqueID,
                rollNo: rollNo,
                name: name,
                dob: document.getElementById('dob').value,
                class: className,
                section: document.getElementById('section').value,
                house: document.getElementById('house').value,
                aadhar: document.getElementById('aadhar').value,
                parent: {
                    father: document.getElementById('fatherName').value,
                    mother: document.getElementById('motherName').value,
                    contact: contact
                },
                address: document.getElementById('address').value,
                facilities: {
                    hostel: document.getElementById('hostel').value,
                    transport: document.getElementById('transport').value,
                    km: document.getElementById('km').value,
                    books: document.getElementById('books').value
                },
                photo: stuPhotoBase64,
                role: "student",
                marks: 0,
                rank: "N/A",
                admissionDate: new Date().toLocaleDateString()
            };

            await setDoc(doc(db, "users", uniqueID), studentData);
            
            msg.style.color = "green";
            msg.innerText = `âœ… Admission Success! ID: ${uniqueID} | Roll No: ${rollNo}`;
            alert(`Admission Done!\nID: ${uniqueID}\nRoll No: ${rollNo}\nPassword: ${contact}`);
            
            setTimeout(() => { location.href = "admin.html"; }, 2000);

        } catch (e) {
            alert("Error: " + e.message);
            btn.disabled = false;
            btn.innerText = "Retry Admission";
        }
    };
</script>
</body>
</html>
